<!DOCTYPE html>
<html>
<style>
  body{
      background-color:rgb(252, 229, 232);
  }

  canvas{
      display: block;
      margin: 0 auto;

  }
  #intro{
    position: absolute;
    left: 400px;
    top: 100px;
    width: 500px;
    font-family: Courier;
    font-weight: bold;
    font-size: 20px;
    border-style: solid;
    border-width: 2px;
    background-color: aquamarine; 
    box-shadow: 10px 10px grey;
  }

  #btn{
    display: none;
    position: absolute;
    left: 400px;
    top: 100px;
    width: 200px;
    font-family: Courier;
    font-weight: bold;
    font-size: 20px;
    border-style: solid;
    border-width: 2px;
    background-color: aquamarine; 
    box-shadow: 10px 10px grey;
  }
</style> 
<body> 
  <p id="intro"> Use the arrow keys or the touchscreen in order to move Pinky Lamb. Try to eat the cookies and avoid the flowers.</p>
    <button id="btn" onclick=playAgain()> Play Again</button>
<canvas id="canvas"></canvas>
<script>
  const cvs = document.getElementById("canvas");
  const ctx = cvs.getContext("2d");
  ctx.canvas.width  = window.innerWidth  - 100;
  ctx.canvas.height = window.innerHeight - 10;

  const intro = document.getElementById("intro");
  const box = cvs.height / 14;

  const p = new Image();
  p.src = "images/Pinky_Lamb.png";
  p.width = 1.3*box;
  p.height = 1.6*box;

  const f = new Image();
  f.src = "images/Pinky_Cookie.png";
  f.width = box;
  f.height = box;

  const b = new Image();
  b.src = "images/Flower.PNG";
  b.width = box;
  b.height = box;

  let img_space = box/5;
  let player = {
    x : cvs.width / 2,
    y : cvs.height / 2,
    width : p.width - img_space,
    height : p.height - img_space,
    health : 3
  }

  let food = [];
  food [0] = {
    x : 0,
    y : cvs.height / 2 - f.height,
    X_step : Math.floor(Math.random()*3 + 3),
    Y_step : Math.floor(Math.random()*12 - 6),
    good : Math.floor(Math.random()*3),
    width : f.width,
    height : f.height

  }

  let score = 0;

  document.addEventListener("touchmove", clearIntro);
  document.addEventListener("keydown", clearIntro);

  intro.style.left = cvs.width / 3 + "px";
  intro.style.top = cvs.height / 3 + "px";

  function clearIntro(){
    intro.textContent = "";
    intro.style.borderStyle = "none";
    intro.style.boxShadow = "none";
  }

  function playAgain(){
    window.location.reload();
  }
  //User Controls
  let d = [];
  document.addEventListener("touchmove", t_move);
  document.addEventListener("keydown", k_down);
  document.addEventListener("keyup", k_up);

  function t_move(event){
    console.log(event.touches[0].screenX);
    player.x = event.touches[0].screenX - 2*cvs.offsetLeft - p.width;
    player.y = event.touches[0].screenY - 2*box - 2*cvs.offsetTop - p.height;
  }

  function k_down(event){
    let k = event.keyCode;
    if(k == 37) d[0] = true;
    if( k == 38) d[1] = true;
    if( k  == 39) d[2] = true;
    if( k  == 40) d[3] = true;
  }

  function k_up(event){
    let k = event.keyCode;
    if(k == 37) d[0] = false;
    if( k == 38) d[1] = false;
    if( k  == 39) d[2] = false;
    if( k  == 40) d[3] = false;
  }

  function collision(rect1, rect2){
  if (rect1.x < rect2.x + rect2.width &&
     rect1.x + rect1.width > rect2.x &&
     rect1.y < rect2.y + rect2.height &&
     rect1.y + rect1.height > rect2.y) {
      // collision detected!
          return true;
      }else{
        return false;
      }
  }

  let t = 0;

  function draw(){
    ctx.canvas.width  = window.innerWidth  - 100;
    ctx.canvas.height = window.innerHeight - 10;
    //Background
    ctx.fillStyle = "#e1aaff";
    ctx.fillRect(0, 0, cvs.width, 2*box);
    ctx.strokeStyle = "white";
    ctx.lineWidth = 6;
    ctx.strokeRect(0 , 0, cvs.width, 2*box);
    ctx.fillStyle = "#c1ffaa";
    ctx.fillRect(0, 2*box, cvs.width, cvs.height - 2 * box);
    ctx.strokeRect(0, 2*box, cvs.width, cvs.height - 2 * box);

    //Lines
    //console.log("(" + player.x + ", " + player.y + "), ( " + food[0].x + ", " + food[0].y + ")");
    //console.log(collision(player, food[0]));
    //food
    for(let i = 0; i < food.length; i++){
      if(food[i].good == 0){
      ctx.drawImage(b, food[i].x, food[i].y, b.width, b.height);
    }else{
      ctx.drawImage(f, food[i].x, food[i].y, f.width, f.height);
    }
    //moves food
      food[i].x += food[i].X_step;
      food[i].y += food[i].Y_step;

      if(food[i].x>=(cvs.width-food[i].width) || food[i].x<=0){
          food[i].X_step = -1*food[i].X_step;
      }
      if(food[i].y>=(cvs.height-food[i].height) || food[i].y<=100){
          food[i].Y_step = -1*food[i].Y_step;
      }

    //Checks if you have eaten food
    if( collision(player, food[i])){
      if(food[i].good == 0){
        player.health--;
        if(player.health == 0){
          ctx.fillStyle = "white";
          ctx.font = "bold 100px Courier"
          ctx.fillText("GAME OVER" , cvs.width / 4, cvs.height / 2);
          ctx.strokeStyle = "black"
          ctx.strokeText("GAME OVER" , cvs.width / 4, cvs.height / 2);
          btn.style.left = cvs.width / 2 - 2*box + "px";
          btn.style.top = cvs.height / 2 + box + "px";
          btn.style.display = "block";
          clearInterval(game);
        }
      }
      score++;
      food.splice(i,1);
    }
      /*ctx.fillStyle = "pink";
      ctx.fillRect(food[i].x, food[i].y, box, box);
      ctx.strokeStyle = "red";
      ctx.strokeRect(food[i].x, food[i].y, box, box);*/
    }

    //Pinky Lamb
    ctx.drawImage(p, player.x - img_space/2, player.y - img_space/2, p.width, p.height);
    //Pinky Lamb Moves
    var step = 10;
    //Changes Direction
    if ( d[0] ) player.x -= step;
    if ( d[1] ) player.y -= step;
    if ( d[2] ) player.x += step;
    if ( d[3] ) player.y += step;

    if(player.y<=100){
      player.y = 101;
    }else if(player.y + player.height >= cvs.height){
       player.y = cvs.height - player.height - 1;
    }else if(player.x <= 0){
      player.x = 1;
    }else if( player.x + player.width >= cvs.width ){
      player.x = cvs.width - player.width - 1;
    }

    t++;
    if(t==40){
      t = 0;
      var newFood = {
        x : 0,
        y : cvs.height / 2 - f.height,
        X_step : Math.floor(Math.random()*3 + 3),
        Y_step : Math.floor(Math.random()*12 - 6),
        width : f.width,
        height : f.height,
        good : Math.floor(Math.random()*3),

      }
      food.push(newFood);
    }

    //GAMEOVER
   /* if (foodX < 0 || foodX >= cvs.width || foodY < 2 * box || foodY >= cvs.height || collision(newHead, food)){
      clearInterval(game);
    }*/

    ctx.fillStyle = "white";
    ctx.font = "bold " + box + "px Courier";
    ctx.fillText("Score: " + score, box, 1.2*box);
    ctx.fillText("Lives: " + player.health, box * 9, 1.2*box);
  };

  //window.requestAnimationFrame(draw);
  let game = setInterval(draw, 20);
</script>
</body>
</html>
